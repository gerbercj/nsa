<!DOCTYPE html>
<html>
<head>
  <title>Not Safe Anymore</title>
</head>


<body>
  <script src="lib/d3.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <!--script src="http://d3js.org/topojson.v1.min.js"></script-->
  <script type="text/javascript" src="lib/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="lib/colorbrewer.js"></script>
  <script type="text/javascript" src="js/waf.js"></script> 
  <script type="text/javascript" src="js/countryCodeUtil.js"></script> 
  <script type="text/javascript" src="js/uiUtil.js"></script> 

  <style type="text/css">
    svg{
      /*background: #B2DFEE;*/
    }

    .country{
      fill: none;
      stroke: black;
    }

    text, body{
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 9pt;
      /*font-weight: bold;*/
    }

    table{
      border: none;
    }

    .attack {
      fill: red;
    }

    div.tooltip {   
      position: absolute;           
      padding: 4px;             
      font: 12px sans-serif;        
      background: white; 
      border: 1px solid black;
      border-radius: 8px;           
      pointer-events: none;         
    }
  </style>

  <div>
    <span id="countrySelector">Region&nbsp;</span>
    <span id="networkSelector">Network&nbsp;</span>
  </div>
  <div id="vis"></div>

  <script type="text/javascript">
    var width = 960, height = 1040;

    var bbMap = {
      top: 310,
      left: 10,
      height: 720,
      width: 940
    }

    var bbPolar = {
      top: 10,
      left:10,
      height: 280,
      width: 280
    }

    var svg = d3.select("#vis").append("svg")
      .attr({
        width: width, 
        height: height
      });

    // Polar plot
    var gPolar = svg.append("g')
      .attr({
        transform: "translate(" + bbPolar.left + "," + bbPolar.top + ")"
      });

    // draws the polar plot
    var drawPolar = function() {
    }

    // Bubble map
    var gMap = svg.append("g")
      .attr({
        transform: "translate(" + bbMap.left + "," + bbMap.top + ")"
      });

    // tooltip div element
    var tooltip = d3.select("body").append("div")   
      .attr("class", "tooltip")               
      .style("opacity", 0);

    // pretty format large numbers
    var numberFormat = d3.format(",.0f");

    // projection used
    var projection = d3.geo.mercator().translate([bbMap.width / 2, bbMap.height / 1.8]);
    // path used to draw the world map
    var path = d3.geo.path().projection(projection);

    // extracts the values for longitude and latitude
    var getLngLat = function(d) {
      return [parseFloat(d.lng), parseFloat(d.lat)];
    }

    // converts lon, lat to x and y using a d3 projection
    var latLngToXY = function(d) {
      return projection(getLngLat(d));
    }

    // draws the world map
    var drawWorld = function(world) {
      gMap.selectAll("path")
        .data(world.features)
        .enter().append("path")
          .attr("class", "country")
          .attr("d", path);
    }

    var showAttacks = function() {
      var data = waf.getAggregatedMapData();

      // create linear scale for the radius
      var rScale = d3.scale.linear()
        .domain(d3.extent(data, function(d) { return d.count; }))
        .range([2, 15]);

      // reset
      gMap.selectAll("attack").remove();

      gMap.selectAll("attack")
        .data(data)
        .enter().append("circle")
          .attr("class", "attack")
          // use projection to figure out cx and cy
          .attr("cx", function(d, i) { return latLngToXY(d)[0]; })
          .attr("cy", function(d, i) { return latLngToXY(d)[1]; })
          .attr("r", function(d) { return 2; })
          // show tooltip
          .on("mouseover", function(d, i) {
            tooltip.transition()   
              .duration(200)      
              .style("opacity", 0.9)

            // city name and count
            var html = d.city + ": <b>" + numberFormat(d.count) + "</b>";
            tooltip.html(html)  
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY) + "px"); 
          })
          // hide tooltip
          .on("mouseout", function(d, i) {
            tooltip.transition()        
              .duration(200)      
              .style("opacity", 0); 
          });
      
    }

    // initialize the visualization
    var initVis = function(error, wafData, world, countries) {

      // stash data
      waf.init(wafData);
      // init utils
      countryCodes.init(countries, world);
      uiUtil.initCountrySelector("#countrySelector");
      uiUtil.initNetworkSelector("#networkSelector");
      // draw world
      drawWorld(world);
      // overlay attacks
      showAttacks();
      // draw polar plot
      drawPolar();
    }

    /*********************************************************************
                                start here
    **********************************************************************/
    // very cool queue function to make multiple calls.. 
    // see [0]
    queue()
      .defer(d3.csv, "../data/waf_5mi")
      .defer(d3.json, "../data/world_data.json")
      .defer(d3.json,"../data/countrycodes.json")
      .await(initVis);
  </script>
</body>
</html>
<!-- REFERENCES
  
-->